version: '3.5'

services:
  postgres:
    container_name: setupshowroom-postgres
    hostname: setupshowroom-postgres
    image: postgres:16.3-alpine
    environment:
      - POSTGRES_DB=setupshowroom
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin123
    ports:
      - "5432:5432"
    networks:
      - setupshowroom
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d setupshowroom"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    container_name: setupshowroom-minio
    hostname: setupshowroom-minio
    image: minio/minio:RELEASE.2025-02-07T23-21-09Z-cpuv1
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=admin123
    ports:
      - "9000:9000"
      - "9001:9001"
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - setupshowroom
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio-mc:
    container_name: setupshowroom-minio-mc
    image: minio/mc:RELEASE.2025-02-15T10-36-16Z-cpuv1
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: /bin/sh
    command:
      - -c
      - |
        sleep 10
        /usr/bin/mc alias set localminio http://setupshowroom-minio:9000 admin admin123
        /usr/bin/mc mb localminio/setupshowroom --ignore-existing
        /usr/bin/mc anonymous set-json /dev/stdin localminio/setupshowroom <<'EOF'
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "AWS": ["*"]
              },
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Resource": [
                "arn:aws:s3:::setupshowroom"
              ]
            },
            {
              "Effect": "Allow",
              "Principal": {
                "AWS": ["*"]
              },
              "Action": [
                "s3:GetObject"
              ],
              "Resource": [
                "arn:aws:s3:::setupshowroom/*"
              ]
            }
          ]
        }
        EOF
        echo "Public access policy applied"
    networks:
      - setupshowroom

  backend:
    container_name: setupshowroom-backend
    hostname: setupshowroom-backend
    build:
      context: ./setupshowroom-backend
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
        - linux/arm64
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - APP_BASE_URL=http://setupshowroom-backend:8080
      - APP_FRONTEND_BASE_URL=http://localhost:4200
      - APP_JWT_SECRET=ODcwYmI1YTJjMjQzYzNmYjQ0ODhlMjM2MGZmYWQ1OTMyZWJhZWM3ZmE3Y2ExNjc5OGVlYTJmMTZmN2Y0ODNhOTc1YzM1MzFjYTRmY2ZiODUyZWJiNTYwNmNkMDAxMDRhMzE0N2RlZGMyYjBhOWY0ZjY1YTkyZTMzNGQxMTYzZTcwYzRkNDNlYzNhNjliNTQzYTI1NWFhMGRkYmIwMTc1ZTZiZGQ2Y2RhY2UwNmZhNDI2NzY4NTBjOGEzODhjMzdiZTcwYTA4MDdjNDZiZjE4ZmM3MmE5MzEzMTY2ODAxZTdiNmIwNDI5ZjgzZWQ4YjQxNzM0NTkzNjg3ZDE2ODYxM2UwZjBiOTQyNWU3NGFkMzcyNmJhM2UwMTc4MGU0MWQwYjU2NTIxYTRhOGE4YmY0ZDAzNWQ2ZTRjNWQ5ZmI3ZGRlNjYxMzkyNjdlZjBlODUxZjNmODhjOTVhODFmOGZmNGVhZDA0ODJiMmI2YmIxMTVkMjhiNzY5MzZkMTljMGZhNmI0YmUwYWE4ZjhhYTIyNzU1ZjAyNWQ0ZTUzMzJjMGViZTJjZDA4NjA0NDM2MDQ1MDc4YWQ5NGEwZjkwYzNmMjdjMDlmZmE5OTgzMzEyYjU=
      - APP_SIGHTENGINE_ACTIVE=false
      - APP_SIGHTENGINE_API_USER=api-user
      - APP_SIGHTENGINE_API_SECRET=api-secret
      - APP_SIGHTENGINE_MODELS=nudity-2.1,recreational_drug,medical,self-harm
      - APP_STORAGE_S3_ENDPOINT=http://setupshowroom-minio:9000
      - APP_STORAGE_S3_PUBLIC_ENDPOINT=http://localhost:9000
      - APP_STORAGE_S3_BASE_PATH=setup-showroom
      - APP_STORAGE_S3_TRASH_PATH=setup-showroom/trash
      - APP_STORAGE_S3_BUCKET=setupshowroom
      - APP_STORAGE_S3_ACCESS_KEY=admin
      - APP_STORAGE_S3_SECRET_KEY=admin123
      - SPRING_CLOUD_AWS_S3_ENABLED=false
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      - SPRING_DATASOURCE_URL=jdbc:postgresql://setupshowroom-postgres:5432/setupshowroom
      - SPRING_DATASOURCE_USERNAME=admin
      - SPRING_DATASOURCE_PASSWORD=admin123
      - SPRING_JPA_SHOW_SQL=false
      - SPRING_JPA_OPEN_IN_VIEW=false
      - SPRING_JPA_GENERATE_DDL=false
      - SPRING_JPA_HIBERNATE_DDL_AUTO=none
      - SPRING_JPA_PROPERTIES_HIBERNATE_NAMING_PHYSICAL_STRATEGY=org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
      - SPRING_JPA_PROPERTIES_HIBERNATE_GLOBALLY_QUOTED_IDENTIFIERS=true
      - SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE=5GB
      - SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE=6GB
      - SPRING_FLYWAY_ENABLED=true
      - SPRING_FLYWAY_SCHEMAS=public
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID=YOUR_CLIENT_ID
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET=YOUR_CLIENT_SECRET
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_SCOPE=profile,email
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_REDIRECT_URI={baseUrl}/login/oauth2/code/google
      - SPRING_PROFILES_ACTIVE=default
      - MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED=true
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info
      - LOGGING_LEVEL_ROOT=WARN
      - JAVA_OPTS=-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-mc:
        condition: service_completed_successfully
    networks:
      - setupshowroom
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health/liveness"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  frontend:
    container_name: setupshowroom-frontend
    hostname: setupshowroom-frontend
    build:
      context: ./setupshowroom-frontend
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
        - linux/arm64
    ports:
      - "4200:80"
    networks:
      - setupshowroom
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

networks:
  setupshowroom:
    name: setupshowroom
    driver: bridge

volumes:
  postgres_data:
  minio_data:
